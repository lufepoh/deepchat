
# 멀티 탭 IPC 통신 아키텍처 분석

## 현재 아키텍처 개요

### 핵심 구성 요소 관계

```scss
여러 개의 WebContentsView (탭)
    ↓ (presenter:call)
단일 IPC 핸들러 (main/presenter/index.ts)
    ↓
여러 Presenter 인스턴스
    ↓ (eventBus)
렌더링 프로세스로 콜백 (잘못된 탭으로 전송될 수 있음)
```

## 현재 구현 분석

### 1. 렌더링 프로세스 단 (`usePresenter.ts`)

* **장점:** 통합된 프록시 인터페이스를 제공하며 안전한 직렬화 기능을 지원합니다.
* **문제:**
  * 모든 탭이 단일 `presenter:call` 채널을 공유합니다.
  * 호출의 출처인 탭 ID를 식별할 수 없습니다.
  * 탭 컨텍스트 정보가 전달되지 않습니다.

### 2. 메인 프로세스 단 (`main/presenter/index.ts`)

* **장점:** 통합된 메서드 호출 분배 메커니즘을 갖추고 있습니다.
* **문제:**
  * `ipcMain.handle`는 `_event`만 받아오며, 실제 호출이 발생한 탭을 파악할 수 없습니다.
  * 오류 처리에서 탭 컨텍스트 정보가 부족합니다.
  * 응답을 호출한 탭에 정확하게 전송할 수 없습니다.

### 3. 이벤트 버스 (`eventbus.ts`)

* **장점:** 유연한 이벤트 분배 메커니즘을 제공합니다.
* **문제:**
  * `sendToRenderer`는 브로드캐스트 모드를 사용하여 잘못된 탭으로 이벤트가 전송될 수 있습니다.
  * 탭 ID 기반의 정확한 이벤트 라우팅이 부재합니다.
  * `SendTarget.DEFAULT_TAB` 개념이 멀티 탭 환경에서 명확하지 않습니다.

### 4. Tab 관리 (`tabPresenter.ts`)

* **장점:** 탭의 생명 주기를 완벽하게 관리하여 탭 상태 매핑을 유지합니다.
* **문제:**
  * 탭 생성 시 IPC 통신 식별 정보와의 연결이 설정되지 않습니다.
  * presenter 호출과의 연계 메커니즘이 부재합니다.

## 핵심 문제 식별

### 1. 호출 출처 인식 문제

```typescript
// 현재 구현은 호출이 어느 탭에서 발생했는지를 구분하지 못합니다.
ipcMain.handle('presenter:call', (_event, name, method, ...payloads) => {
  // _event에는 webContents가 포함되어 있으나, tabId와의 연계 방법은?
})
```

### 2. 응답 라우팅 문제

```typescript
// EventBus의 응답이 잘못된 탭으로 전송될 수 있습니다.
sendToRenderer(eventName: string, target: SendTarget = SendTarget.ALL_WINDOWS, ...args)
// sendToSpecificTab(tabId, eventName, ...args) 메커니즘이 부재합니다.
```

### 3. 상태 동기 문제

* 탭 전환 시 상태가 비동기일 수 있습니다.
* 여러 탭이 자신에게 해당되지 않는 이벤트를 받을 수 있습니다.
* presenter 호출 결과가 잘못된 탭에서 받아들여질 가능성이 있습니다.

### 4. 오류 처리 문제

* 오류 로그에는 탭 컨텍스트 정보가 없습니다.
* 특정 탭의 호출 체인을 추적할 수 없어 디버깅이 어렵습니다.

## 영향 범위 평가

### 고영향 구역

1. 사용자 입력이 탭 A에서 이루어지더라도 결과가 탭 B에 표시될 수 있어 사용자 인터랙션이 혼란스러울 수 있습니다.
2. 여러 탭 간 상태가 서로 미치는 영향이 발생할 수 있습니다.
3. 이벤트가 비활성 탭으로 전송되어 누락될 가능성이 있습니다.

### 중영향 구역

1. 브로드캐스트 이벤트가 의도치 않은 추가 처리를 유발하여 성능에 영향을 줄 수 있습니다.
2. 문제의 발생 탭을 정확히 파악할 수 없어 디버깅이 어렵습니다.
3. 명료한 통신 경계가 부재하여 코드 유지보수가 어려울 수 있습니다.

## 기술 채무 식별

### 1. 아키텍처 채무

* 단일 IPC 채널 설계가 멀티 탭 아키텍처에 부합하지 않습니다.
* 이벤트 시스템이 정확한 라우팅 기능을 갖추고 있지 않습니다.

### 2. 유지보수성 채무

* 호출 체인이 모호합니다.
* 오류 처리가 불완전하여 디버깅에 어려움이 있습니다.
* 통합된 탭 컨텍스트 관리가 부재합니다.

### 3. 확장성 채무

* 탭별 기능 지원이 어렵습니다.
* 탭 간의 격리를 구현하기 어렵습니다.
* 복잡한 멀티 윈도우/멀티 탭 시나리오를 지원하기 어렵습니다.

## 제안 최적화 방향

### 1. 단기 (후진 호환)

* 현재 `presenter:call`에 탭 ID 파라미터 추가
* EventBus의 탭 ID 기반 정확한 이벤트 라우팅 지원 확장
* 오류 처리에서 탭 컨텍스트 정보 추가 개선

### 2. 중기 (아키텍처 조정)

* 탭별 IPC 채널 관리 설계
* 탭 단위의 presenter 인스턴스 격리 구현
* 완전한 탭 컨텍스트 전달 메커니즘 수립

### 3. 장기 (재설계)

* 보다 현대적인 IPC 아키텍처(예: Service Worker 기반) 도입을 검토
* 완전한 탭 간 격리 구현
* 보다 복잡한 멀티 윈도우/멀티 탭 시나리오 지원

## 리스크 평가

### 최적화 리스크

* **호환성 리스크:** 기존 코드는 현재 IPC 메커니즘에 의존합니다.
* **복잡성 리스크:** 과도한 설계가 유지보수 비용을 증가시킬 수 있습니다.
* **성능 리스크:** 새로운 메커니즘이 추가 오버헤드를 초래할 수 있습니다.

### 미최적화 리스크

* **사용자 경험 리스크:** 탭 간의 지속적인 혼란 문제.
* **개발 효율성 리스크:** 디버깅 및 유지보수가 어려울 수 있습니다.
* **확장성 리스크:** 새로운 멀티 탭 기능 요구를 지원할 수 없을 가능성이 있습니다.

## 다음 단계 실행

1. 구체적인 실행 계획 수립
2. 새로운 IPC 통신 프로토콜 설계
3. 후진 호환성을 유지하는 점진적인 업그레이드 구현
4. 종합된 테스트 커버리지 구축
